---
# 完整配置所有运维系统 - 全自动化
# LLDAP 用户 + Next Terminal 资产 + Grafana Dashboard + Homarr

- name: 配置运维系统
  hosts: ops
  become: yes
  vars:
    ops_domain: "ops.hbf.ink"
    secrets: "{{ lookup('community.sops.sops', playbook_dir + '/../secrets.enc.yml') | from_yaml }}"
    prod_wg_ip: "10.10.0.2"
    ops_wg_ip: "10.10.0.1"
    # 用户配置
    admin_user: "calvinhong"
    admin_email: "calvinaistudio@gmail.com"
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
    SOPS_AGE_SSH_PRIVATE_KEY_FILE: "{{ ansible_env.HOME }}/.ssh/id_ed25519"
  tasks:
    # ============ LLDAP 创建用户 ============
    - name: 等待 LLDAP 就绪
      shell: kubectl wait --for=condition=Ready pod -l app=lldap -n ops --timeout=120s

    - name: 获取 LLDAP Pod
      shell: kubectl get pod -n ops -l app=lldap -o jsonpath='{.items[0].metadata.name}'
      register: lldap_pod

    - name: 检查用户是否存在
      shell: |
        kubectl exec -n ops {{ lldap_pod.stdout }} -- \
          /app/lldap_set_password --help 2>&1 || true
      register: lldap_check
      ignore_errors: yes

    - name: 通过 LLDAP GraphQL API 创建用户
      shell: |
        # 获取 JWT token
        TOKEN=$(kubectl exec -n ops {{ lldap_pod.stdout }} -- \
          curl -s -X POST http://localhost:17170/api/login \
          -H "Content-Type: application/json" \
          -d '{"username": "admin", "password": "{{ secrets.ops.lldap_admin_password }}"}' \
          | grep -o '"token":"[^"]*"' | cut -d'"' -f4)
        
        # 创建用户
        kubectl exec -n ops {{ lldap_pod.stdout }} -- \
          curl -s -X POST http://localhost:17170/api/graphql \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer $TOKEN" \
          -d '{
            "query": "mutation { createUser(user: {id: \"{{ admin_user }}\", email: \"{{ admin_email }}\", displayName: \"Calvin Hong\"}) { id } }"
          }' || true
        
        # 设置密码
        kubectl exec -n ops {{ lldap_pod.stdout }} -- \
          curl -s -X POST http://localhost:17170/api/graphql \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer $TOKEN" \
          -d '{
            "query": "mutation { updateUser(user: {id: \"{{ admin_user }}\", password: \"{{ secrets.ops.lldap_admin_password }}\"}) { id } }"
          }' || true
        
        # 添加到 lldap_admin 组
        kubectl exec -n ops {{ lldap_pod.stdout }} -- \
          curl -s -X POST http://localhost:17170/api/graphql \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer $TOKEN" \
          -d '{
            "query": "mutation { addUserToGroup(userId: \"{{ admin_user }}\", groupId: 1) { ok } }"
          }' || true
      register: lldap_user_result

    # ============ Grafana 配置 ============
    - name: 获取 Grafana admin 密码
      shell: kubectl get secret -n monitoring grafana -o jsonpath="{.data.admin-password}" | base64 -d
      register: grafana_password

    - name: 配置 Grafana 数据源
      shell: |
        cat <<'EOF' | kubectl apply -f -
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: grafana-datasources
          namespace: monitoring
          labels:
            grafana_datasource: "1"
        data:
          datasources.yaml: |
            apiVersion: 1
            datasources:
              - name: Prometheus
                type: prometheus
                url: http://prometheus-server.monitoring.svc.cluster.local
                access: proxy
                isDefault: true
              - name: Loki
                type: loki
                url: http://loki.monitoring.svc.cluster.local:3100
                access: proxy
              - name: Tempo
                type: tempo
                url: http://tempo.monitoring.svc.cluster.local:3100
                access: proxy
        EOF

    - name: 配置 Grafana sub path 和 LDAP
      shell: |
        cat <<'EOF' | kubectl apply -f -
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: grafana-config
          namespace: monitoring
        data:
          grafana.ini: |
            [server]
            root_url = https://{{ ops_domain }}/grafana
            serve_from_sub_path = true
            
            [auth.ldap]
            enabled = true
            config_file = /etc/grafana/ldap.toml
            allow_sign_up = true
            
            [security]
            admin_user = admin
          
          ldap.toml: |
            [[servers]]
            host = "lldap.ops.svc.cluster.local"
            port = 3890
            use_ssl = false
            start_tls = false
            bind_dn = "uid=admin,ou=people,dc=ops,dc=hbf,dc=ink"
            bind_password = "{{ secrets.ops.lldap_admin_password }}"
            search_filter = "(uid=%s)"
            search_base_dns = ["ou=people,dc=ops,dc=hbf,dc=ink"]
            
            [servers.attributes]
            name = "displayName"
            surname = "sn"
            username = "uid"
            email = "mail"
            
            [[servers.group_mappings]]
            group_dn = "cn=lldap_admin,ou=groups,dc=ops,dc=hbf,dc=ink"
            org_role = "Admin"
            
            [[servers.group_mappings]]
            group_dn = "*"
            org_role = "Viewer"
        EOF

    - name: 更新 Grafana Deployment
      shell: |
        kubectl patch deployment grafana -n monitoring --type='strategic' -p='
        spec:
          template:
            spec:
              containers:
              - name: grafana
                volumeMounts:
                - name: grafana-config
                  mountPath: /etc/grafana/grafana.ini
                  subPath: grafana.ini
                - name: grafana-config
                  mountPath: /etc/grafana/ldap.toml
                  subPath: ldap.toml
              volumes:
              - name: grafana-config
                configMap:
                  name: grafana-config
        '
      register: grafana_patch
      failed_when: false

    - name: 重启 Grafana
      shell: kubectl rollout restart deployment grafana -n monitoring

    # ============ Grafana Dashboard ============
    - name: 创建 K8s 集群 Dashboard
      shell: |
        cat <<'EOF' | kubectl apply -f -
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: grafana-dashboards
          namespace: monitoring
          labels:
            grafana_dashboard: "1"
        data:
          k8s-cluster.json: |
            {
              "dashboard": {
                "title": "K8s Cluster Overview",
                "uid": "k8s-cluster",
                "panels": [
                  {
                    "title": "CPU Usage",
                    "type": "timeseries",
                    "gridPos": {"x": 0, "y": 0, "w": 12, "h": 8},
                    "targets": [{"expr": "sum(rate(container_cpu_usage_seconds_total[5m])) by (instance)", "legendFormat": "{% raw %}{{instance}}{% endraw %}"}],
                    "datasource": "Prometheus"
                  },
                  {
                    "title": "Memory Usage",
                    "type": "timeseries",
                    "gridPos": {"x": 12, "y": 0, "w": 12, "h": 8},
                    "targets": [{"expr": "sum(container_memory_usage_bytes) by (instance) / 1024 / 1024 / 1024", "legendFormat": "{% raw %}{{instance}}{% endraw %}"}],
                    "datasource": "Prometheus"
                  },
                  {
                    "title": "Pod Count",
                    "type": "stat",
                    "gridPos": {"x": 0, "y": 8, "w": 6, "h": 4},
                    "targets": [{"expr": "count(kube_pod_info)", "legendFormat": "Pods"}],
                    "datasource": "Prometheus"
                  },
                  {
                    "title": "Node Count",
                    "type": "stat",
                    "gridPos": {"x": 6, "y": 8, "w": 6, "h": 4},
                    "targets": [{"expr": "count(kube_node_info)", "legendFormat": "Nodes"}],
                    "datasource": "Prometheus"
                  }
                ],
                "schemaVersion": 38
              },
              "overwrite": true
            }
        EOF

    # ============ Next Terminal 配置 ============
    - name: 等待 Next Terminal 就绪
      shell: kubectl wait --for=condition=Ready pod -l app=next-terminal -n bastion --timeout=120s

    - name: 获取 Next Terminal Pod
      shell: kubectl get pod -n bastion -l app=next-terminal -o jsonpath='{.items[0].metadata.name}'
      register: terminal_pod

    - name: 配置 Next Terminal (通过 API)
      shell: |
        # 登录获取 token
        TOKEN=$(kubectl exec -n bastion {{ terminal_pod.stdout }} -- \
          curl -s -X POST http://localhost:8088/api/login \
          -H "Content-Type: application/json" \
          -d '{"username": "admin", "password": "admin"}' 2>/dev/null \
          | grep -o '"token":"[^"]*"' | cut -d'"' -f4 || echo "")
        
        if [ -n "$TOKEN" ]; then
          # 修改 admin 密码
          kubectl exec -n bastion {{ terminal_pod.stdout }} -- \
            curl -s -X PUT http://localhost:8088/api/users/admin \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $TOKEN" \
            -d '{"password": "{{ secrets.ops.lldap_admin_password }}"}' || true
          
          # 添加运维机资产
          kubectl exec -n bastion {{ terminal_pod.stdout }} -- \
            curl -s -X POST http://localhost:8088/api/assets \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $TOKEN" \
            -d '{
              "name": "ops-tokyo-01",
              "protocol": "ssh",
              "ip": "{{ ops_wg_ip }}",
              "port": 22,
              "username": "ubuntu",
              "privateKey": "",
              "description": "运维机 (WireGuard)"
            }' || true
          
          # 添加业务机资产
          kubectl exec -n bastion {{ terminal_pod.stdout }} -- \
            curl -s -X POST http://localhost:8088/api/assets \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $TOKEN" \
            -d '{
              "name": "prod-tokyo-01",
              "protocol": "ssh",
              "ip": "{{ prod_wg_ip }}",
              "port": 22,
              "username": "root",
              "privateKey": "",
              "description": "业务机 (WireGuard)"
            }' || true
        fi
      register: terminal_config
      ignore_errors: yes

    # ============ Ingress 配置 ============
    - name: 配置统一 Ingress
      shell: |
        cat <<'EOF' | kubectl apply -f -
        apiVersion: networking.k8s.io/v1
        kind: Ingress
        metadata:
          name: ops-ingress
          namespace: ops
          annotations:
            cert-manager.io/cluster-issuer: letsencrypt-prod
        spec:
          ingressClassName: traefik
          tls:
          - hosts:
            - {{ ops_domain }}
            secretName: ops-tls
          rules:
          - host: {{ ops_domain }}
            http:
              paths:
              - path: /
                pathType: Prefix
                backend:
                  service:
                    name: homarr
                    port:
                      number: 7575
              - path: /lldap
                pathType: Prefix
                backend:
                  service:
                    name: lldap
                    port:
                      number: 17170
        ---
        apiVersion: networking.k8s.io/v1
        kind: Ingress
        metadata:
          name: grafana-ingress
          namespace: monitoring
          annotations:
            cert-manager.io/cluster-issuer: letsencrypt-prod
        spec:
          ingressClassName: traefik
          tls:
          - hosts:
            - {{ ops_domain }}
            secretName: grafana-tls
          rules:
          - host: {{ ops_domain }}
            http:
              paths:
              - path: /grafana
                pathType: Prefix
                backend:
                  service:
                    name: grafana
                    port:
                      number: 80
        ---
        apiVersion: networking.k8s.io/v1
        kind: Ingress
        metadata:
          name: terminal-ingress
          namespace: bastion
          annotations:
            cert-manager.io/cluster-issuer: letsencrypt-prod
        spec:
          ingressClassName: traefik
          tls:
          - hosts:
            - {{ ops_domain }}
            secretName: terminal-tls
          rules:
          - host: {{ ops_domain }}
            http:
              paths:
              - path: /terminal
                pathType: Prefix
                backend:
                  service:
                    name: next-terminal
                    port:
                      number: 8088
        EOF

    # ============ Homarr 配置 ============
    - name: 创建 Homarr 配置
      copy:
        content: |
          {
            "schemaVersion": 1,
            "configProperties": {
              "name": "Sub2API Ops"
            },
            "categories": [],
            "wrappers": [{"id": "default", "position": 0}],
            "apps": [
              {
                "id": "grafana",
                "name": "Grafana 监控",
                "url": "https://{{ ops_domain }}/grafana",
                "behaviour": {"isOpeningNewTab": false},
                "network": {"enabledStatusChecker": true, "statusCodes": ["200", "302"]},
                "appearance": {"iconUrl": "https://cdn.jsdelivr.net/gh/walkxcode/dashboard-icons/png/grafana.png"},
                "area": {"type": "wrapper", "properties": {"id": "default"}},
                "shape": {"lg": {"location": {"x": 0, "y": 0}, "size": {"width": 2, "height": 1}}}
              },
              {
                "id": "terminal",
                "name": "Next Terminal",
                "url": "https://{{ ops_domain }}/terminal",
                "behaviour": {"isOpeningNewTab": false},
                "network": {"enabledStatusChecker": true, "statusCodes": ["200", "302"]},
                "appearance": {"iconUrl": "https://cdn.jsdelivr.net/gh/walkxcode/dashboard-icons/png/terminal.png"},
                "area": {"type": "wrapper", "properties": {"id": "default"}},
                "shape": {"lg": {"location": {"x": 2, "y": 0}, "size": {"width": 2, "height": 1}}}
              },
              {
                "id": "lldap",
                "name": "LLDAP 用户管理",
                "url": "https://{{ ops_domain }}/lldap",
                "behaviour": {"isOpeningNewTab": false},
                "network": {"enabledStatusChecker": true, "statusCodes": ["200", "302"]},
                "appearance": {"iconUrl": "https://cdn.jsdelivr.net/gh/walkxcode/dashboard-icons/png/authelia.png"},
                "area": {"type": "wrapper", "properties": {"id": "default"}},
                "shape": {"lg": {"location": {"x": 4, "y": 0}, "size": {"width": 2, "height": 1}}}
              }
            ],
            "widgets": [
              {
                "id": "cluster-info",
                "type": "markdown",
                "properties": {
                  "content": "## 集群信息\\n- 运维机: {{ ops_wg_ip }}\\n- 业务机: {{ prod_wg_ip }}\\n- 域名: {{ ops_domain }}"
                },
                "area": {"type": "wrapper", "properties": {"id": "default"}},
                "shape": {"lg": {"location": {"x": 0, "y": 1}, "size": {"width": 3, "height": 1}}}
              }
            ]
          }
        dest: /data/homarr/configs/default.json
        mode: '0644'

    - name: 重启 Homarr
      shell: kubectl rollout restart deployment homarr -n ops

    # ============ 等待服务就绪 ============
    - name: 等待所有服务就绪
      shell: |
        kubectl rollout status deployment grafana -n monitoring --timeout=120s
        kubectl rollout status deployment homarr -n ops --timeout=60s

    # ============ 输出信息 ============
    - name: 显示访问信息
      shell: |
        echo "==========================================="
        echo "      运维系统配置完成 - 全自动化"
        echo "==========================================="
        echo ""
        echo "统一入口: https://{{ ops_domain }}"
        echo ""
        echo "--- 服务 ---"
        echo "Homarr:    https://{{ ops_domain }}"
        echo "Grafana:   https://{{ ops_domain }}/grafana"
        echo "Terminal:  https://{{ ops_domain }}/terminal"
        echo "LLDAP:     https://{{ ops_domain }}/lldap"
        echo ""
        echo "--- 统一账号 ---"
        echo "用户名: {{ admin_user }}"
        echo "密码:   {{ secrets.ops.lldap_admin_password }}"
        echo ""
        echo "Grafana 支持 LDAP 登录，使用上述账号"
        echo "Terminal 密码已自动修改为统一密码"
        echo ""
        echo "--- 服务器资产 (已添加到 Terminal) ---"
        echo "ops-tokyo-01: {{ ops_wg_ip }} (ubuntu)"
        echo "prod-tokyo-01: {{ prod_wg_ip }} (root)"
        echo "==========================================="
      register: info

    - name: 输出
      debug:
        var: info.stdout_lines
