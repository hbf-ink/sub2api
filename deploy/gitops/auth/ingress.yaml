---
# Traefik ForwardAuth 中间件
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: authelia
spec:
  forwardAuth:
    address: http://authelia.auth.svc.cluster.local:9091/api/authz/forward-auth
    trustForwardHeader: true
    authResponseHeaders:
      - Remote-User
      - Remote-Groups
      - Remote-Email
      - Remote-Name
---
# StripPrefix 中间件
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: strip-authelia
spec:
  stripPrefix:
    prefixes:
      - /authelia
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: strip-lldap
spec:
  stripPrefix:
    prefixes:
      - /lldap
---
# Authelia Ingress (不需要认证)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: authelia-ingress
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    traefik.ingress.kubernetes.io/router.middlewares: auth-strip-authelia@kubernetescrd
spec:
  ingressClassName: traefik
  tls:
  - hosts:
    - ops.hbf.ink
    secretName: auth-tls
  rules:
  - host: ops.hbf.ink
    http:
      paths:
      - path: /authelia
        pathType: Prefix
        backend:
          service:
            name: authelia
            port:
              number: 9091
---
# LLDAP Ingress (需要 Authelia 认证)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: lldap-ingress
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    traefik.ingress.kubernetes.io/router.middlewares: auth-authelia@kubernetescrd,auth-strip-lldap@kubernetescrd
spec:
  ingressClassName: traefik
  tls:
  - hosts:
    - ops.hbf.ink
    secretName: auth-tls
  rules:
  - host: ops.hbf.ink
    http:
      paths:
      - path: /lldap
        pathType: Prefix
        backend:
          service:
            name: lldap
            port:
              number: 17170
