---
# 统一认证 + 运维首页
# 自动使用 SOPS 解密 secrets.enc.yml

- name: 部署统一认证和运维首页
  hosts: ops
  become: yes
  vars:
    ops_domain: "ops.hbf.ink"
    acme_email: "calvin@hbf.ink"
    admin_user: "calvinhong"
    admin_email: "calvin@hbf.ink"
    ldap_base_dn: "dc=ops,dc=hbf,dc=ink"
    secrets: "{{ lookup('community.sops.sops', playbook_dir + '/../secrets.enc.yml') | from_yaml }}"
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
    SOPS_AGE_SSH_PRIVATE_KEY_FILE: "{{ ansible_env.HOME }}/.ssh/id_ed25519"
  tasks:
    - name: 创建 ops namespace
      shell: kubectl create namespace ops --dry-run=client -o yaml | kubectl apply -f -

    # ============ LLDAP ============
    - name: 创建 LLDAP 数据目录
      file:
        path: /data/lldap
        state: directory
        mode: '0755'

    - name: 部署 LLDAP
      shell: |
        cat <<'EOF' | kubectl apply -f -
        apiVersion: v1
        kind: Secret
        metadata:
          name: lldap-secrets
          namespace: ops
        type: Opaque
        stringData:
          LLDAP_JWT_SECRET: "{{ secrets.ops.lldap_jwt_secret }}"
          LLDAP_LDAP_USER_PASS: "{{ secrets.ops.lldap_admin_password }}"
        ---
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: lldap
          namespace: ops
        spec:
          replicas: 1
          selector:
            matchLabels:
              app: lldap
          template:
            metadata:
              labels:
                app: lldap
            spec:
              containers:
              - name: lldap
                image: lldap/lldap:stable
                ports:
                - containerPort: 3890
                  name: ldap
                - containerPort: 17170
                  name: web
                env:
                - name: LLDAP_LDAP_BASE_DN
                  value: "{{ ldap_base_dn }}"
                - name: LLDAP_LDAP_USER_DN
                  value: "{{ admin_user }}"
                - name: LLDAP_LDAP_USER_EMAIL
                  value: "{{ admin_email }}"
                - name: LLDAP_JWT_SECRET
                  valueFrom:
                    secretKeyRef:
                      name: lldap-secrets
                      key: LLDAP_JWT_SECRET
                - name: LLDAP_LDAP_USER_PASS
                  valueFrom:
                    secretKeyRef:
                      name: lldap-secrets
                      key: LLDAP_LDAP_USER_PASS
                volumeMounts:
                - name: data
                  mountPath: /data
              volumes:
              - name: data
                hostPath:
                  path: /data/lldap
                  type: DirectoryOrCreate
              nodeSelector:
                node-role: ops
        ---
        apiVersion: v1
        kind: Service
        metadata:
          name: lldap
          namespace: ops
        spec:
          selector:
            app: lldap
          ports:
          - name: ldap
            port: 3890
          - name: web
            port: 17170
        EOF

    # ============ Homarr ============
    - name: 创建 Homarr 数据目录
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /data/homarr
        - /data/homarr/configs
        - /data/homarr/icons
        - /data/homarr/data

    - name: 部署 Homarr
      shell: |
        cat <<'EOF' | kubectl apply -f -
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: homarr
          namespace: ops
        spec:
          replicas: 1
          selector:
            matchLabels:
              app: homarr
          template:
            metadata:
              labels:
                app: homarr
            spec:
              containers:
              - name: homarr
                image: ghcr.io/homarr-labs/homarr:v1.50.1
                ports:
                - containerPort: 7575
                env:
                - name: SECRET_ENCRYPTION_KEY
                  value: "{{ secrets.ops.homarr_secret_key }}"
                - name: AUTH_SECRET
                  value: "{{ secrets.ops.homarr_auth_secret }}"
                - name: AUTH_PROVIDERS
                  value: "ldap"
                - name: AUTH_LDAP_URI
                  value: "ldap://lldap.ops.svc.cluster.local:3890"
                - name: AUTH_LDAP_BASE
                  value: "{{ ldap_base_dn }}"
                - name: AUTH_LDAP_BIND_DN
                  value: "uid={{ admin_user }},ou=people,{{ ldap_base_dn }}"
                - name: AUTH_LDAP_BIND_PASSWORD
                  value: "{{ secrets.ops.lldap_admin_password }}"
                - name: AUTH_LDAP_USERNAME_ATTRIBUTE
                  value: "uid"
                - name: AUTH_LDAP_USER_MAIL_ATTRIBUTE
                  value: "mail"
                - name: AUTH_LDAP_GROUP_CLASS
                  value: "groupOfUniqueNames"
                - name: AUTH_LDAP_GROUP_MEMBER_ATTRIBUTE
                  value: "member"
                - name: AUTH_LDAP_GROUP_MEMBER_USER_ATTRIBUTE
                  value: "dn"
                - name: AUTH_LDAP_SEARCH_SCOPE
                  value: "sub"
                volumeMounts:
                - name: data
                  mountPath: /appdata
              volumes:
              - name: data
                hostPath:
                  path: /data/homarr
                  type: DirectoryOrCreate
              nodeSelector:
                node-role: ops
        ---
        apiVersion: v1
        kind: Service
        metadata:
          name: homarr
          namespace: ops
        spec:
          selector:
            app: homarr
          ports:
          - port: 7575
        EOF

    # ============ Cert-Manager ============
    - name: 安装 cert-manager
      shell: |
        kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.14.4/cert-manager.yaml
      register: cert_manager_install

    - name: 等待 cert-manager webhook 就绪
      shell: kubectl wait --for=condition=Available deployment/cert-manager-webhook -n cert-manager --timeout=180s
      retries: 5
      delay: 15

    - name: 创建 ClusterIssuer
      shell: |
        cat <<'EOF' | kubectl apply -f -
        apiVersion: cert-manager.io/v1
        kind: ClusterIssuer
        metadata:
          name: letsencrypt-prod
        spec:
          acme:
            server: https://acme-v02.api.letsencrypt.org/directory
            email: {{ acme_email }}
            privateKeySecretRef:
              name: letsencrypt-prod-key
            solvers:
            - http01:
                ingress:
                  class: traefik
        EOF
      retries: 5
      delay: 15

    # ============ Ingress ============
    - name: 开放 80/443 端口
      shell: ufw allow 80/tcp; ufw allow 443/tcp

    - name: 创建跨 namespace Service
      shell: |
        cat <<'EOF' | kubectl apply -f -
        apiVersion: v1
        kind: Service
        metadata:
          name: grafana-external
          namespace: ops
        spec:
          type: ExternalName
          externalName: grafana.monitoring.svc.cluster.local
        ---
        apiVersion: v1
        kind: Service
        metadata:
          name: terminal-external
          namespace: ops
        spec:
          type: ExternalName
          externalName: next-terminal.bastion.svc.cluster.local
        EOF

    - name: 创建 StripPrefix 中间件
      shell: |
        cat <<'EOF' | kubectl apply -f -
        apiVersion: traefik.io/v1alpha1
        kind: Middleware
        metadata:
          name: strip-lldap
          namespace: ops
        spec:
          stripPrefix:
            prefixes:
              - /lldap
        ---
        apiVersion: traefik.io/v1alpha1
        kind: Middleware
        metadata:
          name: strip-terminal
          namespace: ops
        spec:
          stripPrefix:
            prefixes:
              - /terminal
        EOF

    - name: 部署 Ingress
      shell: |
        cat <<'EOF' | kubectl apply -f -
        apiVersion: networking.k8s.io/v1
        kind: Ingress
        metadata:
          name: ops-ingress
          namespace: ops
          annotations:
            cert-manager.io/cluster-issuer: letsencrypt-prod
        spec:
          ingressClassName: traefik
          tls:
          - hosts:
            - {{ ops_domain }}
            secretName: ops-tls
          rules:
          - host: {{ ops_domain }}
            http:
              paths:
              - path: /
                pathType: Prefix
                backend:
                  service:
                    name: homarr
                    port:
                      number: 7575
              - path: /grafana
                pathType: Prefix
                backend:
                  service:
                    name: grafana-external
                    port:
                      number: 80
        ---
        apiVersion: networking.k8s.io/v1
        kind: Ingress
        metadata:
          name: lldap-ingress
          namespace: ops
          annotations:
            cert-manager.io/cluster-issuer: letsencrypt-prod
            traefik.ingress.kubernetes.io/router.middlewares: ops-strip-lldap@kubernetescrd
        spec:
          ingressClassName: traefik
          tls:
          - hosts:
            - {{ ops_domain }}
            secretName: ops-tls
          rules:
          - host: {{ ops_domain }}
            http:
              paths:
              - path: /lldap
                pathType: Prefix
                backend:
                  service:
                    name: lldap
                    port:
                      number: 17170
        ---
        apiVersion: networking.k8s.io/v1
        kind: Ingress
        metadata:
          name: terminal-ingress
          namespace: ops
          annotations:
            cert-manager.io/cluster-issuer: letsencrypt-prod
            traefik.ingress.kubernetes.io/router.middlewares: ops-strip-terminal@kubernetescrd
        spec:
          ingressClassName: traefik
          tls:
          - hosts:
            - {{ ops_domain }}
            secretName: ops-tls
          rules:
          - host: {{ ops_domain }}
            http:
              paths:
              - path: /terminal
                pathType: Prefix
                backend:
                  service:
                    name: terminal-external
                    port:
                      number: 8088
        EOF

    # ============ 等待部署完成 ============
    - name: 等待 Pod 就绪
      shell: |
        kubectl wait --for=condition=Ready pod -l app=lldap -n ops --timeout=120s
        kubectl wait --for=condition=Ready pod -l app=homarr -n ops --timeout=120s
      retries: 3
      delay: 10

    # ============ 配置 Homarr LDAP ============
    - name: 等待 Homarr 数据库初始化
      shell: |
        for i in {1..30}; do
          if [ -f /data/homarr/db/db.sqlite ]; then
            echo "Database ready"
            exit 0
          fi
          sleep 2
        done
        echo "Database not found"
        exit 1

    - name: 检查 Homarr onboarding 状态
      shell: |
        sqlite3 /data/homarr/db/db.sqlite "SELECT step FROM onboarding LIMIT 1;"
      register: homarr_onboarding_status
      changed_when: false

    - name: 配置 Homarr 跳过 onboarding 并设置 LDAP 管理员组
      shell: |
        # 停止 Homarr 以便修改数据库
        kubectl scale deployment/homarr -n ops --replicas=0
        sleep 3
        
        # 确保数据库可写
        chmod 777 /data/homarr/db
        chmod 666 /data/homarr/db/db.sqlite
        
        DB=/data/homarr/db/db.sqlite
        
        # 设置 onboarding 为完成状态
        sqlite3 $DB "UPDATE onboarding SET step = 'finish';"
        
        # 创建与 LLDAP 同名的管理员组 (lldap_admin)
        sqlite3 $DB "INSERT OR IGNORE INTO \"group\" (id, name, position) VALUES ('lldap_admin_group', 'lldap_admin', 0);"
        
        # 给组赋予所有管理员权限
        sqlite3 $DB "INSERT OR IGNORE INTO groupPermission (group_id, permission) VALUES 
        ('lldap_admin_group', 'admin'),
        ('lldap_admin_group', 'board-create'),
        ('lldap_admin_group', 'board-full-all'),
        ('lldap_admin_group', 'integration-create'),
        ('lldap_admin_group', 'integration-full-all'),
        ('lldap_admin_group', 'integration-use-all');"
        
        # 创建默认 board
        sqlite3 $DB "INSERT OR IGNORE INTO board (id, name, is_public, page_title, meta_title, primary_color, secondary_color, opacity) VALUES 
        ('ops_board', 'Ops Dashboard', 1, 'HBF Ops', 'HBF Ops', '#fa5252', '#fd7e14', 100);"
        
        # 创建 layout
        sqlite3 $DB "INSERT OR IGNORE INTO layout (id, name, board_id, column_count, breakpoint) VALUES 
        ('layout_default', 'default', 'ops_board', 10, 0);"
        
        # 创建 apps
        sqlite3 $DB "INSERT OR IGNORE INTO app (id, name, icon_url, href, description) VALUES 
        ('app_grafana', 'Grafana', 'https://cdn.jsdelivr.net/gh/selfhst/icons@main/svg/grafana.svg', 'https://{{ ops_domain }}/grafana', '监控仪表盘'),
        ('app_prometheus', 'Prometheus', 'https://cdn.jsdelivr.net/gh/selfhst/icons@main/svg/prometheus.svg', 'https://{{ ops_domain }}/grafana/explore?orgId=1&left=%7B%22datasource%22:%22prometheus%22%7D', '指标查询'),
        ('app_loki', 'Loki', 'https://cdn.jsdelivr.net/gh/selfhst/icons@main/svg/loki.svg', 'https://{{ ops_domain }}/grafana/explore?orgId=1&left=%7B%22datasource%22:%22loki%22%7D', '日志查询'),
        ('app_tempo', 'Tempo', 'https://cdn.jsdelivr.net/gh/selfhst/icons@main/svg/grafana.svg', 'https://{{ ops_domain }}/grafana/explore?orgId=1&left=%7B%22datasource%22:%22tempo%22%7D', '链路追踪'),
        ('app_alertmanager', 'Alertmanager', 'https://cdn.jsdelivr.net/gh/selfhst/icons@main/svg/prometheus.svg', 'https://{{ ops_domain }}/grafana/alerting/list', '告警管理'),
        ('app_lldap', 'LLDAP', 'https://cdn.jsdelivr.net/gh/selfhst/icons@main/svg/lldap.svg', 'https://{{ ops_domain }}/lldap', '用户管理'),
        ('app_terminal', 'Next Terminal', 'https://cdn.jsdelivr.net/gh/selfhst/icons@main/svg/apache-guacamole.svg', 'https://{{ ops_domain }}/terminal', '堡垒机');"
        
        # 创建 section (kind=empty 不可折叠)
        sqlite3 $DB "INSERT OR IGNORE INTO section (id, board_id, kind, x_offset, y_offset, name) VALUES 
        ('section_monitor', 'ops_board', 'empty', 0, 0, '监控'),
        ('section_manage', 'ops_board', 'empty', 0, 3, '管理');"
        
        # 创建 item (关联 board 和 app)
        sqlite3 $DB "INSERT OR IGNORE INTO item (id, board_id, kind, options, advanced_options) VALUES 
        ('item_grafana', 'ops_board', 'app', '{\"json\":{\"appId\":\"app_grafana\"}}', '{\"json\":{}}'),
        ('item_prometheus', 'ops_board', 'app', '{\"json\":{\"appId\":\"app_prometheus\"}}', '{\"json\":{}}'),
        ('item_loki', 'ops_board', 'app', '{\"json\":{\"appId\":\"app_loki\"}}', '{\"json\":{}}'),
        ('item_tempo', 'ops_board', 'app', '{\"json\":{\"appId\":\"app_tempo\"}}', '{\"json\":{}}'),
        ('item_alertmanager', 'ops_board', 'app', '{\"json\":{\"appId\":\"app_alertmanager\"}}', '{\"json\":{}}'),
        ('item_lldap', 'ops_board', 'app', '{\"json\":{\"appId\":\"app_lldap\"}}', '{\"json\":{}}'),
        ('item_terminal', 'ops_board', 'app', '{\"json\":{\"appId\":\"app_terminal\"}}', '{\"json\":{}}');"
        
        # 创建 item_layout (关联 item, section, layout)
        sqlite3 $DB "INSERT OR IGNORE INTO item_layout (item_id, section_id, layout_id, x_offset, y_offset, width, height) VALUES 
        ('item_grafana', 'section_monitor', 'layout_default', 0, 0, 2, 2),
        ('item_prometheus', 'section_monitor', 'layout_default', 2, 0, 2, 2),
        ('item_loki', 'section_monitor', 'layout_default', 4, 0, 2, 2),
        ('item_tempo', 'section_monitor', 'layout_default', 6, 0, 2, 2),
        ('item_alertmanager', 'section_monitor', 'layout_default', 8, 0, 2, 2),
        ('item_lldap', 'section_manage', 'layout_default', 0, 0, 2, 2),
        ('item_terminal', 'section_manage', 'layout_default', 2, 0, 2, 2);"
        
        # 设置默认 board
        sqlite3 $DB "UPDATE serverSetting SET value = '{\"json\":{\"homeBoardId\":\"ops_board\",\"mobileHomeBoardId\":\"ops_board\",\"enableStatusByDefault\":true,\"forceDisableStatus\":false}}' WHERE setting_key = 'board';"
        
        # 重启 Homarr
        kubectl scale deployment/homarr -n ops --replicas=1
        kubectl wait --for=condition=Ready pod -l app=homarr -n ops --timeout=120s
        
        echo "Homarr LDAP 配置完成"
      when: homarr_onboarding_status.stdout != 'finish'

    - name: 显示状态
      shell: |
        echo "=== Pods ===" && kubectl get pods -n ops
        echo "=== Ingress ===" && kubectl get ingress -n ops
        echo ""
        echo "访问: https://{{ ops_domain }}"
        echo "LLDAP: https://{{ ops_domain }}/lldap ({{ admin_user }} / {{ secrets.ops.lldap_admin_password }})"
      register: status

    - name: 输出
      debug:
        var: status.stdout_lines
