---
# 在运维机安装 K3s Server
- name: 安装 K3s Server
  hosts: ops
  become: yes
  tasks:
    - name: 安装 K3s Server (使用 WireGuard IP)
      shell: |
        curl -sfL https://get.k3s.io | sh -s - \
          --write-kubeconfig-mode 644 \
          --node-ip {{ wireguard_ip }} \
          --advertise-address {{ wireguard_ip }} \
          --flannel-iface wg0
      args:
        creates: /usr/local/bin/k3s

    - name: 等待 K3s 启动
      shell: kubectl get nodes
      register: k3s_ready
      retries: 30
      delay: 5
      until: k3s_ready.rc == 0

    - name: 获取 K3s Token
      slurp:
        src: /var/lib/rancher/k3s/server/node-token
      register: k3s_token

    - name: 保存 Token 到变量
      set_fact:
        k3s_join_token: "{{ k3s_token.content | b64decode | trim }}"

    - name: 获取实际节点名称
      shell: kubectl get nodes -o jsonpath='{.items[0].metadata.name}'
      register: actual_node_name

    - name: 给节点打标签
      shell: kubectl label node {{ actual_node_name.stdout }} node-role=ops --overwrite

    - name: 安装 Helm
      shell: curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      args:
        creates: /usr/local/bin/helm

    - name: 配置 KUBECONFIG 环境变量
      lineinfile:
        path: /etc/environment
        line: 'KUBECONFIG=/etc/rancher/k3s/k3s.yaml'
        create: yes

    - name: 安装 K9s
      shell: |
        curl -sS https://webi.sh/k9s | sh
      args:
        creates: /root/.local/bin/k9s
      environment:
        HOME: /root
