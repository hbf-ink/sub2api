---
# 部署 ArgoCD
# ArgoCD 负责管理所有应用层服务

- name: 部署 ArgoCD
  hosts: ops
  become: yes
  vars:
    argocd_version: "v2.13.3"
    argocd_namespace: "argocd"
    ops_domain: "ops.hbf.ink"
    gitops_repo: "https://github.com/hbf-ink/sub2api.git"
    gitops_path: "deploy/gitops"
    secrets: "{{ lookup('community.sops.sops', playbook_dir + '/../secrets.enc.yml') | from_yaml }}"
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  tasks:
    - name: 创建 argocd namespace
      shell: kubectl create namespace {{ argocd_namespace }} --dry-run=client -o yaml | kubectl apply -f -

    - name: 安装 ArgoCD
      shell: |
        kubectl apply -n {{ argocd_namespace }} -f https://raw.githubusercontent.com/argoproj/argo-cd/{{ argocd_version }}/manifests/install.yaml
      register: argocd_install

    - name: 等待 ArgoCD 就绪
      shell: |
        kubectl wait --for=condition=Available deployment/argocd-server -n {{ argocd_namespace }} --timeout=300s
        kubectl wait --for=condition=Available deployment/argocd-repo-server -n {{ argocd_namespace }} --timeout=300s
        kubectl wait --for=condition=Available deployment/argocd-applicationset-controller -n {{ argocd_namespace }} --timeout=300s
      retries: 3
      delay: 10

    # ============ 创建应用 Secrets（从 SOPS 读取）============
    - name: 生成随机密钥
      shell: |
        echo "lldap_jwt=$(openssl rand -hex 32)"
        echo "authelia_jwt=$(openssl rand -hex 64)"
        echo "authelia_session=$(openssl rand -hex 64)"
        echo "authelia_storage=$(openssl rand -hex 64)"
        echo "homarr_encryption=$(openssl rand -hex 32)"
        echo "homarr_auth=$(openssl rand -hex 32)"
        echo "homarr_oidc=$(openssl rand -hex 32)"
      register: random_secrets
      changed_when: false

    - name: 创建 auth namespace
      shell: kubectl create namespace auth --dry-run=client -o yaml | kubectl apply -f -

    - name: 创建 LLDAP secrets
      shell: |
        kubectl create secret generic lldap-secrets -n auth \
          --from-literal=LLDAP_JWT_SECRET="{{ random_secrets.stdout_lines[0].split('=')[1] }}" \
          --from-literal=LLDAP_LDAP_USER_PASS="{{ secrets.ops.lldap_admin_password }}" \
          --dry-run=client -o yaml | kubectl apply -f -

    - name: 创建 Authelia secrets
      shell: |
        kubectl create secret generic authelia-secrets -n auth \
          --from-literal=JWT_SECRET="{{ random_secrets.stdout_lines[1].split('=')[1] }}" \
          --from-literal=SESSION_SECRET="{{ random_secrets.stdout_lines[2].split('=')[1] }}" \
          --from-literal=STORAGE_ENCRYPTION_KEY="{{ random_secrets.stdout_lines[3].split('=')[1] }}" \
          --from-literal=LDAP_PASSWORD="{{ secrets.ops.lldap_admin_password }}" \
          --dry-run=client -o yaml | kubectl apply -f -

    - name: 创建 ops namespace
      shell: kubectl create namespace ops --dry-run=client -o yaml | kubectl apply -f -

    - name: 创建 Homarr secrets
      shell: |
        kubectl create secret generic homarr-secrets -n ops \
          --from-literal=SECRET_ENCRYPTION_KEY="{{ random_secrets.stdout_lines[4].split('=')[1] }}" \
          --from-literal=AUTH_SECRET="{{ random_secrets.stdout_lines[5].split('=')[1] }}" \
          --from-literal=AUTH_OIDC_CLIENT_SECRET="{{ random_secrets.stdout_lines[6].split('=')[1] }}" \
          --dry-run=client -o yaml | kubectl apply -f -

    - name: 配置 ArgoCD Ingress
      shell: |
        cat <<'EOF' | kubectl apply -f -
        apiVersion: networking.k8s.io/v1
        kind: Ingress
        metadata:
          name: argocd-ingress
          namespace: {{ argocd_namespace }}
          annotations:
            cert-manager.io/cluster-issuer: letsencrypt-prod
            traefik.ingress.kubernetes.io/router.tls: "true"
            nginx.ingress.kubernetes.io/ssl-passthrough: "true"
            nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
        spec:
          ingressClassName: traefik
          tls:
          - hosts:
            - {{ ops_domain }}
            secretName: argocd-tls
          rules:
          - host: {{ ops_domain }}
            http:
              paths:
              - path: /argocd
                pathType: Prefix
                backend:
                  service:
                    name: argocd-server
                    port:
                      number: 443
        EOF

    - name: 配置 ArgoCD 使用 insecure 模式 (TLS 由 Traefik 处理)
      shell: |
        kubectl patch configmap argocd-cmd-params-cm -n {{ argocd_namespace }} --type merge -p '{"data":{"server.insecure":"true","server.rootpath":"/argocd"}}'
        kubectl rollout restart deployment/argocd-server -n {{ argocd_namespace }}
        kubectl wait --for=condition=Available deployment/argocd-server -n {{ argocd_namespace }} --timeout=120s

    - name: 获取 ArgoCD 初始密码
      shell: |
        kubectl -n {{ argocd_namespace }} get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
      register: argocd_password
      changed_when: false

    - name: 创建 App of Apps
      shell: |
        cat <<'EOF' | kubectl apply -f -
        apiVersion: argoproj.io/v1alpha1
        kind: Application
        metadata:
          name: apps
          namespace: {{ argocd_namespace }}
        spec:
          project: default
          source:
            repoURL: {{ gitops_repo }}
            targetRevision: HEAD
            path: {{ gitops_path }}/apps
          destination:
            server: https://kubernetes.default.svc
            namespace: {{ argocd_namespace }}
          syncPolicy:
            automated:
              prune: true
              selfHeal: true
        EOF

    - name: 显示访问信息
      debug:
        msg: |
          =========================================
          ArgoCD 部署完成
          =========================================
          
          访问地址: https://{{ ops_domain }}/argocd
          用户名: admin
          密码: {{ argocd_password.stdout }}
          
          所有应用将通过 GitOps 自动部署
          =========================================
