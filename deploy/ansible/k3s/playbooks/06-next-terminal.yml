---
# 部署 Next Terminal 堡垒机
- name: 部署 Next Terminal
  hosts: ops
  become: yes
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  tasks:
    - name: 创建 bastion namespace
      shell: kubectl create namespace bastion --dry-run=client -o yaml | kubectl apply -f -

    - name: 创建数据目录
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /data/next-terminal/data
        - /data/next-terminal/logs
        - /data/next-terminal/postgresql

    - name: 创建 Next Terminal ConfigMap
      shell: |
        cat <<'EOF' | kubectl apply -f -
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: next-terminal-config
          namespace: bastion
        data:
          config.yaml: |
            Database:
              Enabled: true
              Type: postgres
              Postgres:
                Hostname: postgresql
                Port: 5432
                Username: next-terminal
                Password: {{ next_terminal_db_password }}
                Database: next-terminal
              ShowSql: false
            log:
              Level: info
              Filename: /usr/local/next-terminal/logs/nt.log
            Server:
              Addr: "0.0.0.0:8088"
            App:
              Website:
                AccessLog: "/usr/local/next-terminal/logs/access.log"
              Recording:
                Type: "local"
                Path: "/usr/local/next-terminal/data/recordings"
              Guacd:
                Drive: "/usr/local/next-terminal/data/drive"
                Hosts:
                  - Hostname: guacd
                    Port: 4822
                    Weight: 1
        EOF

    - name: 部署 PostgreSQL
      shell: |
        cat <<'EOF' | kubectl apply -f -
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: postgresql
          namespace: bastion
        spec:
          replicas: 1
          selector:
            matchLabels:
              app: postgresql
          template:
            metadata:
              labels:
                app: postgresql
            spec:
              nodeSelector:
                node-role: ops
              containers:
              - name: postgresql
                image: postgres:16.4
                env:
                - name: POSTGRES_DB
                  value: next-terminal
                - name: POSTGRES_USER
                  value: next-terminal
                - name: POSTGRES_PASSWORD
                  value: {{ next_terminal_db_password }}
                ports:
                - containerPort: 5432
                volumeMounts:
                - name: data
                  mountPath: /var/lib/postgresql/data
                resources:
                  limits:
                    memory: 256Mi
                  requests:
                    memory: 128Mi
              volumes:
              - name: data
                hostPath:
                  path: /data/next-terminal/postgresql
                  type: DirectoryOrCreate
        ---
        apiVersion: v1
        kind: Service
        metadata:
          name: postgresql
          namespace: bastion
        spec:
          selector:
            app: postgresql
          ports:
          - port: 5432
            targetPort: 5432
        EOF

    - name: 部署 Guacd
      shell: |
        cat <<'EOF' | kubectl apply -f -
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: guacd
          namespace: bastion
        spec:
          replicas: 1
          selector:
            matchLabels:
              app: guacd
          template:
            metadata:
              labels:
                app: guacd
            spec:
              nodeSelector:
                node-role: ops
              containers:
              - name: guacd
                image: dushixiang/guacd:latest
                ports:
                - containerPort: 4822
                volumeMounts:
                - name: data
                  mountPath: /usr/local/next-terminal/data
                resources:
                  limits:
                    memory: 256Mi
                  requests:
                    memory: 128Mi
              volumes:
              - name: data
                hostPath:
                  path: /data/next-terminal/data
                  type: DirectoryOrCreate
        ---
        apiVersion: v1
        kind: Service
        metadata:
          name: guacd
          namespace: bastion
        spec:
          selector:
            app: guacd
          ports:
          - port: 4822
            targetPort: 4822
        EOF

    - name: 部署 Next Terminal
      shell: |
        cat <<'EOF' | kubectl apply -f -
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: next-terminal
          namespace: bastion
        spec:
          replicas: 1
          selector:
            matchLabels:
              app: next-terminal
          template:
            metadata:
              labels:
                app: next-terminal
            spec:
              nodeSelector:
                node-role: ops
              containers:
              - name: next-terminal
                image: dushixiang/next-terminal:latest
                ports:
                - containerPort: 8088
                - containerPort: 2022
                volumeMounts:
                - name: config
                  mountPath: /etc/next-terminal
                - name: data
                  mountPath: /usr/local/next-terminal/data
                - name: logs
                  mountPath: /usr/local/next-terminal/logs
                resources:
                  limits:
                    memory: {{ resources.next_terminal.memory_limit }}
                  requests:
                    memory: {{ resources.next_terminal.memory_request }}
              volumes:
              - name: config
                configMap:
                  name: next-terminal-config
              - name: data
                hostPath:
                  path: /data/next-terminal/data
                  type: DirectoryOrCreate
              - name: logs
                hostPath:
                  path: /data/next-terminal/logs
                  type: DirectoryOrCreate
        ---
        apiVersion: v1
        kind: Service
        metadata:
          name: next-terminal
          namespace: bastion
        spec:
          type: NodePort
          selector:
            app: next-terminal
          ports:
          - name: web
            port: 8088
            targetPort: 8088
            nodePort: 30088
          - name: ssh
            port: 2022
            targetPort: 2022
            nodePort: 30022
        EOF

    - name: 等待 Next Terminal 就绪
      shell: kubectl wait --for=condition=ready pod -l app=next-terminal -n bastion --timeout=300s
      register: nt_ready
      retries: 5
      delay: 30
      until: nt_ready.rc == 0
      ignore_errors: yes

    - name: 显示 bastion 状态
      shell: kubectl get pods -n bastion
      register: bastion_status

    - name: 输出状态
      debug:
        var: bastion_status.stdout_lines
