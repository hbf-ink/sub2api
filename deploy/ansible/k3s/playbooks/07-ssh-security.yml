---
# SSH 安全加固
- name: 配置业务机防火墙
  hosts: prod
  become: yes
  vars:
    ops_wg_ip: "10.10.0.1"
  tasks:
    - name: 安装 UFW
      apt:
        name: ufw
        state: present

    - name: 重置 UFW 规则
      shell: ufw --force reset

    - name: 默认拒绝入站
      shell: ufw default deny incoming

    - name: 默认允许出站
      shell: ufw default allow outgoing

    - name: 允许运维机 SSH 访问 (WireGuard)
      shell: ufw allow from {{ ops_wg_ip }} to any port 22

    - name: 临时保留公网 SSH (防止被锁)
      shell: ufw allow 22/tcp

    - name: 允许 WireGuard 端口
      shell: ufw allow 51820/udp

    - name: 允许 K3s Agent 端口 (从运维机)
      shell: ufw allow from {{ ops_wg_ip }} to any port 10250

    - name: 允许 HTTP/HTTPS
      shell: |
        ufw allow 80/tcp
        ufw allow 443/tcp

    - name: 启用 UFW
      shell: ufw --force enable

    - name: 显示 UFW 状态
      shell: ufw status verbose
      register: ufw_status

    - name: 输出 UFW 状态
      debug:
        var: ufw_status.stdout_lines

- name: 配置运维机防火墙
  hosts: ops
  become: yes
  tasks:
    - name: 安装 UFW
      apt:
        name: ufw
        state: present

    - name: 重置 UFW 规则
      shell: ufw --force reset

    - name: 默认拒绝入站
      shell: ufw default deny incoming

    - name: 默认允许出站
      shell: ufw default allow outgoing

    - name: 允许 SSH
      shell: ufw allow 22/tcp

    - name: 允许 WireGuard
      shell: ufw allow 51820/udp

    - name: 允许 K3s API
      shell: ufw allow 6443/tcp

    - name: 允许 Grafana
      shell: ufw allow 30030/tcp

    - name: 允许 Next Terminal
      shell: ufw allow 30088/tcp

    - name: 启用 UFW
      shell: ufw --force enable

    - name: 显示 UFW 状态
      shell: ufw status verbose
      register: ufw_status

    - name: 输出 UFW 状态
      debug:
        var: ufw_status.stdout_lines
