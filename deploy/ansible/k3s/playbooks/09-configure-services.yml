---
# 配置所有运维系统使用 LDAP 统一认证
# 单一用户源: LLDAP，改密码全部生效

- name: 配置 LDAP 统一认证
  hosts: ops
  become: yes
  vars:
    ops_domain: "ops.hbf.ink"
    secrets: "{{ lookup('community.sops.sops', playbook_dir + '/../secrets.enc.yml') | from_yaml }}"
    prod_wg_ip: "10.10.0.2"
    ops_wg_ip: "10.10.0.1"
    admin_user: "calvinhong"
    admin_email: "calvinaistudio@gmail.com"
    ldap_base_dn: "dc=ops,dc=hbf,dc=ink"
    ldap_host: "lldap.ops.svc.cluster.local"
    ldap_port: 3890
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
    SOPS_AGE_SSH_PRIVATE_KEY_FILE: "{{ ansible_env.HOME }}/.ssh/id_ed25519"
  tasks:
    # ============ LLDAP 创建用户 ============
    - name: 等待 LLDAP 就绪
      shell: kubectl wait --for=condition=Ready pod -l app=lldap -n ops --timeout=120s

    - name: 获取 LLDAP Pod
      shell: kubectl get pod -n ops -l app=lldap -o jsonpath='{.items[0].metadata.name}'
      register: lldap_pod

    - name: 创建管理员用户 calvinhong
      shell: |
        # 获取 JWT token
        TOKEN=$(kubectl exec -n ops {{ lldap_pod.stdout }} -- \
          curl -s -X POST http://localhost:17170/api/login \
          -H "Content-Type: application/json" \
          -d '{"username": "admin", "password": "{{ secrets.ops.lldap_admin_password }}"}' \
          | grep -o '"token":"[^"]*"' | cut -d'"' -f4)
        
        if [ -n "$TOKEN" ]; then
          # 创建用户
          kubectl exec -n ops {{ lldap_pod.stdout }} -- \
            curl -s -X POST http://localhost:17170/api/graphql \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $TOKEN" \
            -d '{"query": "mutation { createUser(user: {id: \"{{ admin_user }}\", email: \"{{ admin_email }}\", displayName: \"Calvin Hong\"}) { id } }"}' 2>/dev/null || true
          
          # 设置密码
          kubectl exec -n ops {{ lldap_pod.stdout }} -- \
            curl -s -X POST http://localhost:17170/api/graphql \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $TOKEN" \
            -d '{"query": "mutation { updateUser(user: {id: \"{{ admin_user }}\", password: \"{{ secrets.ops.lldap_admin_password }}\"}) { id } }"}' 2>/dev/null || true
          
          # 添加到 lldap_admin 组
          kubectl exec -n ops {{ lldap_pod.stdout }} -- \
            curl -s -X POST http://localhost:17170/api/graphql \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $TOKEN" \
            -d '{"query": "mutation { addUserToGroup(userId: \"{{ admin_user }}\", groupId: 1) { ok } }"}' 2>/dev/null || true
          
          echo "用户 {{ admin_user }} 创建完成"
        fi
      register: lldap_result

    # ============ Grafana LDAP 配置 ============
    - name: 配置 Grafana LDAP
      shell: |
        cat <<'EOF' | kubectl apply -f -
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: grafana-config
          namespace: monitoring
        data:
          grafana.ini: |
            [server]
            root_url = https://{{ ops_domain }}/grafana
            serve_from_sub_path = true
            
            [auth.ldap]
            enabled = true
            config_file = /etc/grafana/ldap.toml
            allow_sign_up = true
            
            [auth]
            disable_login_form = false
          
          ldap.toml: |
            [[servers]]
            host = "{{ ldap_host }}"
            port = {{ ldap_port }}
            use_ssl = false
            start_tls = false
            bind_dn = "uid=admin,ou=people,{{ ldap_base_dn }}"
            bind_password = "{{ secrets.ops.lldap_admin_password }}"
            search_filter = "(uid=%s)"
            search_base_dns = ["ou=people,{{ ldap_base_dn }}"]
            
            [servers.attributes]
            name = "displayName"
            surname = "sn"
            username = "uid"
            email = "mail"
            
            [[servers.group_mappings]]
            group_dn = "cn=lldap_admin,ou=groups,{{ ldap_base_dn }}"
            org_role = "Admin"
            
            [[servers.group_mappings]]
            group_dn = "*"
            org_role = "Viewer"
        EOF

    - name: 更新 Grafana 挂载配置
      shell: |
        kubectl patch deployment grafana -n monitoring --type='json' -p='[
          {"op": "replace", "path": "/spec/template/spec/volumes", "value": [
            {"name": "grafana-storage", "emptyDir": {}},
            {"name": "grafana-config", "configMap": {"name": "grafana-config"}}
          ]},
          {"op": "replace", "path": "/spec/template/spec/containers/0/volumeMounts", "value": [
            {"name": "grafana-storage", "mountPath": "/var/lib/grafana"},
            {"name": "grafana-config", "mountPath": "/etc/grafana/grafana.ini", "subPath": "grafana.ini"},
            {"name": "grafana-config", "mountPath": "/etc/grafana/ldap.toml", "subPath": "ldap.toml"}
          ]}
        ]'
      register: grafana_patch
      failed_when: false

    - name: 重启 Grafana
      shell: kubectl rollout restart deployment grafana -n monitoring

    # ============ Next Terminal LDAP 配置 ============
    - name: 更新 Next Terminal 配置启用 LDAP
      shell: |
        cat <<'EOF' | kubectl apply -f -
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: next-terminal-config
          namespace: bastion
        data:
          config.yaml: |
            Database:
              Enabled: true
              Type: postgres
              Postgres:
                Hostname: postgresql
                Port: 5432
                Username: next-terminal
                Password: next-terminal
                Database: next-terminal
            Server:
              Addr: "0.0.0.0:8088"
            Ldap:
              Enabled: true
              Url: "ldap://{{ ldap_host }}:{{ ldap_port }}"
              BaseDn: "{{ ldap_base_dn }}"
              BindDn: "uid=admin,ou=people,{{ ldap_base_dn }}"
              BindPassword: "{{ secrets.ops.lldap_admin_password }}"
              UserFilter: "(uid={0})"
              AdminGroupDn: "cn=lldap_admin,ou=groups,{{ ldap_base_dn }}"
            App:
              Guacd:
                Hosts:
                  - Hostname: guacd
                    Port: 4822
                    Weight: 1
        EOF

    - name: 重启 Next Terminal
      shell: kubectl rollout restart deployment next-terminal -n bastion

    # ============ 添加服务器资产 (通过数据库) ============
    - name: 等待 Next Terminal 就绪
      shell: kubectl rollout status deployment next-terminal -n bastion --timeout=120s

    - name: 添加服务器资产到 Next Terminal
      shell: |
        cat << 'EOSQL' | kubectl exec -i -n bastion deploy/postgresql -- psql -U next-terminal -d next-terminal
        INSERT INTO asset (id, name, protocol, ip, port, username, account_type, created_at, updated_at, description)
        SELECT gen_random_uuid()::text, 'ops-tokyo-01', 'ssh', '{{ ops_wg_ip }}', 22, 'ubuntu', 'custom', extract(epoch from now())::bigint, extract(epoch from now())::bigint, '运维机'
        WHERE NOT EXISTS (SELECT 1 FROM asset WHERE name='ops-tokyo-01');
        
        INSERT INTO asset (id, name, protocol, ip, port, username, account_type, created_at, updated_at, description)
        SELECT gen_random_uuid()::text, 'prod-tokyo-01', 'ssh', '{{ prod_wg_ip }}', 22, 'root', 'custom', extract(epoch from now())::bigint, extract(epoch from now())::bigint, '业务机'
        WHERE NOT EXISTS (SELECT 1 FROM asset WHERE name='prod-tokyo-01');
        EOSQL

    # ============ Grafana 数据源和 Dashboard ============
    - name: 配置 Grafana 数据源
      shell: |
        cat <<'EOF' | kubectl apply -f -
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: grafana-datasources
          namespace: monitoring
          labels:
            grafana_datasource: "1"
        data:
          datasources.yaml: |
            apiVersion: 1
            datasources:
              - name: Prometheus
                type: prometheus
                url: http://prometheus-server.monitoring.svc.cluster.local
                access: proxy
                isDefault: true
              - name: Loki
                type: loki
                url: http://loki.monitoring.svc.cluster.local:3100
                access: proxy
              - name: Tempo
                type: tempo
                url: http://tempo.monitoring.svc.cluster.local:3100
                access: proxy
        EOF

    # ============ Ingress 配置 ============
    - name: 配置统一 Ingress
      shell: |
        cat <<'EOF' | kubectl apply -f -
        apiVersion: networking.k8s.io/v1
        kind: Ingress
        metadata:
          name: ops-ingress
          namespace: ops
          annotations:
            cert-manager.io/cluster-issuer: letsencrypt-prod
        spec:
          ingressClassName: traefik
          tls:
          - hosts:
            - {{ ops_domain }}
            secretName: ops-tls
          rules:
          - host: {{ ops_domain }}
            http:
              paths:
              - path: /
                pathType: Prefix
                backend:
                  service:
                    name: homarr
                    port:
                      number: 7575
              - path: /lldap
                pathType: Prefix
                backend:
                  service:
                    name: lldap
                    port:
                      number: 17170
        ---
        apiVersion: networking.k8s.io/v1
        kind: Ingress
        metadata:
          name: grafana-ingress
          namespace: monitoring
          annotations:
            cert-manager.io/cluster-issuer: letsencrypt-prod
        spec:
          ingressClassName: traefik
          tls:
          - hosts:
            - {{ ops_domain }}
            secretName: grafana-tls
          rules:
          - host: {{ ops_domain }}
            http:
              paths:
              - path: /grafana
                pathType: Prefix
                backend:
                  service:
                    name: grafana
                    port:
                      number: 80
        ---
        apiVersion: networking.k8s.io/v1
        kind: Ingress
        metadata:
          name: terminal-ingress
          namespace: bastion
          annotations:
            cert-manager.io/cluster-issuer: letsencrypt-prod
        spec:
          ingressClassName: traefik
          tls:
          - hosts:
            - {{ ops_domain }}
            secretName: terminal-tls
          rules:
          - host: {{ ops_domain }}
            http:
              paths:
              - path: /terminal
                pathType: Prefix
                backend:
                  service:
                    name: next-terminal
                    port:
                      number: 8088
        EOF

    # ============ Homarr 配置 ============
    - name: 创建 Homarr 配置
      copy:
        content: |
          {
            "schemaVersion": 1,
            "configProperties": {"name": "Sub2API Ops"},
            "wrappers": [{"id": "default", "position": 0}],
            "apps": [
              {"id": "grafana", "name": "Grafana", "url": "https://{{ ops_domain }}/grafana", "appearance": {"iconUrl": "https://cdn.jsdelivr.net/gh/walkxcode/dashboard-icons/png/grafana.png"}, "area": {"type": "wrapper", "properties": {"id": "default"}}, "shape": {"lg": {"location": {"x": 0, "y": 0}, "size": {"width": 2, "height": 1}}}},
              {"id": "terminal", "name": "Terminal", "url": "https://{{ ops_domain }}/terminal", "appearance": {"iconUrl": "https://cdn.jsdelivr.net/gh/walkxcode/dashboard-icons/png/terminal.png"}, "area": {"type": "wrapper", "properties": {"id": "default"}}, "shape": {"lg": {"location": {"x": 2, "y": 0}, "size": {"width": 2, "height": 1}}}},
              {"id": "lldap", "name": "LLDAP", "url": "https://{{ ops_domain }}/lldap", "appearance": {"iconUrl": "https://cdn.jsdelivr.net/gh/walkxcode/dashboard-icons/png/authelia.png"}, "area": {"type": "wrapper", "properties": {"id": "default"}}, "shape": {"lg": {"location": {"x": 4, "y": 0}, "size": {"width": 2, "height": 1}}}}
            ],
            "widgets": []
          }
        dest: /data/homarr/configs/default.json
        mode: '0644'

    - name: 重启 Homarr
      shell: kubectl rollout restart deployment homarr -n ops

    # ============ 等待服务就绪 ============
    - name: 等待所有服务就绪
      shell: |
        kubectl rollout status deployment grafana -n monitoring --timeout=120s
        kubectl rollout status deployment homarr -n ops --timeout=60s
        kubectl rollout status deployment next-terminal -n bastion --timeout=60s

    # ============ 输出信息 ============
    - name: 显示访问信息
      debug:
        msg: |
          =========================================
          LDAP 统一认证配置完成
          =========================================
          
          统一入口: https://{{ ops_domain }}
          
          --- 所有服务使用同一账号 ---
          用户名: {{ admin_user }}
          密码:   {{ secrets.ops.lldap_admin_password }}
          
          修改密码: 在 LLDAP 修改后全部生效
          https://{{ ops_domain }}/lldap
          
          --- 服务 ---
          Homarr:   https://{{ ops_domain }}
          Grafana:  https://{{ ops_domain }}/grafana
          Terminal: https://{{ ops_domain }}/terminal
          LLDAP:    https://{{ ops_domain }}/lldap
          =========================================
