---
# 基础环境初始化
- name: 初始化所有节点基础环境
  hosts: all
  become: yes
  tasks:
    - name: 更新 apt 缓存
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: 安装基础工具
      apt:
        name:
          - curl
          - wget
          - vim
          - htop
          - net-tools
          - jq
          - unzip
          - python3-pip
          - sshpass
        state: present

    - name: 设置时区为 Asia/Shanghai
      timezone:
        name: Asia/Shanghai

    - name: 清理 Zeabur 预装 K3s (如果存在)
      shell: |
        /usr/local/bin/k3s-uninstall.sh 2>/dev/null || true
        /usr/local/bin/k3s-agent-uninstall.sh 2>/dev/null || true
        rm -rf /var/lib/rancher /etc/rancher
      ignore_errors: yes

# Ops 节点额外依赖
- name: 安装 Ops 节点依赖
  hosts: ops
  become: yes
  tasks:
    - name: 安装 Ansible
      apt:
        name: ansible
        state: present

    - name: 安装 SOPS 3.11+
      shell: |
        if ! command -v sops &> /dev/null || [[ $(sops -v 2>&1 | grep -oP '\d+\.\d+' | head -1) < "3.11" ]]; then
          curl -sLO https://github.com/getsops/sops/releases/download/v3.11.0/sops-v3.11.0.linux.amd64
          chmod +x sops-v3.11.0.linux.amd64
          mv sops-v3.11.0.linux.amd64 /usr/local/bin/sops
        fi
      args:
        creates: /usr/local/bin/sops

    - name: 安装 Ansible SOPS 插件
      shell: ansible-galaxy collection install community.sops -f
      become: no

    - name: 配置 SSH 密钥认证本机
      shell: |
        if [ -f ~/.ssh/id_ed25519 ]; then
          ssh-keygen -y -f ~/.ssh/id_ed25519 > ~/.ssh/id_ed25519.pub 2>/dev/null || true
          grep -qxF "$(cat ~/.ssh/id_ed25519.pub)" ~/.ssh/authorized_keys 2>/dev/null || cat ~/.ssh/id_ed25519.pub >> ~/.ssh/authorized_keys
          chmod 600 ~/.ssh/authorized_keys
          ssh-keyscan -H localhost >> ~/.ssh/known_hosts 2>/dev/null || true
          ssh-keyscan -H $(hostname -I | awk '{print $1}') >> ~/.ssh/known_hosts 2>/dev/null || true
        fi
      become: no
